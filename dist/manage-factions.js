async function buildNotOwnedAugmentationsList(ns, faction, ownedAugmentations) {
    const augmentations = ns.singularity.getAugmentationsFromFaction(faction);
    const notOwnedAugmentations = [];
    for (const augmentation of augmentations) {
        if (ownedAugmentations.includes(augmentation)) {
            continue;
        }
        notOwnedAugmentations.push(augmentation);
    }
    return notOwnedAugmentations;
}
async function getNextFaction(ns) {
    const factionsOfInterest = [
        'Netburners', 'CyberSec', 'NiteSec', 'The Black Hand', 'BitRunners',
        'Sector-12', 'Slum Snakes', 'Volhaven', 'Chongqing',
        'The Covenant', 'Illuminati', 'Daedalus'
    ];
    const ownedAugmentations = ns.singularity.getOwnedAugmentations(true);
    for (const faction of factionsOfInterest) {
        ns.print(`Trying to join ${faction}`);
        if (ns.gang.inGang()) {
            const gangInformation = ns.gang.getGangInformation();
            if (gangInformation['faction'] == faction) {
                ns.print(`Skipping gang faction: ${faction}`);
                continue;
            }
        }
        if (faction == 'Volhaven') { // For 'combat rib II'
            while (ns.getServerMoneyAvailable('home') < 200000) {
                ns.print('Waiting for money for Volhaven');
                await ns.sleep(500);
            }
            ns.singularity.travelToCity('Volhaven');
        }
        else if (faction == 'Chongqing') { // For 'Neuregen Gene Modification'
            while (ns.getServerMoneyAvailable('home') < 200000) {
                ns.print('Waiting for money for Chongqing');
                await ns.sleep(500);
            }
            ns.singularity.travelToCity('Chongqing');
        }
        // For required skills other than hacking
        if (['The Covenant', 'Illuminati', 'Daedalus'].includes(faction)) { // To increase combat stat
            ns.singularity.joinFaction('The Black Hand');
            ns.singularity.workForFaction('The Black Hand', 'field');
        }
        else if (['Slum Snakes'].includes(faction)) { // To lower player karma
            ns.singularity.commitCrime("Mug");
        }
        while (!ns.singularity.checkFactionInvitations().includes(faction) && !ns.getPlayer().factions.includes(faction)) {
            await ns.sleep(5000);
        }
        const notOwnedAugmentations = await buildNotOwnedAugmentationsList(ns, faction, ownedAugmentations);
        ns.print(`Faction: ${faction}, num of not owned aug: ${notOwnedAugmentations.length}`);
        if (notOwnedAugmentations.length == 0) {
            continue;
        }
        return faction;
    }
    return 'NO-FACTION-LEFT';
}
async function waitForReputation(ns, faction, augmentation) {
    while (ns.singularity.getAugmentationRepReq(augmentation) > ns.singularity.getFactionRep(faction)) {
        ns.print(`Augmentation reputation: ${ns.format.number(ns.singularity.getAugmentationRepReq(augmentation))}, current reputation: ${ns.format.number(ns.singularity.getFactionRep(faction))}`);
        await ns.sleep(5000);
    }
}
async function waitForMoney(ns, augmentation) {
    while (ns.singularity.getAugmentationPrice(augmentation) > ns.getServerMoneyAvailable('home')) {
        ns.print(`Augmentation price: ${ns.format.number(ns.singularity.getAugmentationPrice(augmentation))}\$, money available: ${ns.format.number(ns.getServerMoneyAvailable('home'))}\$`);
        await ns.sleep(5000);
    }
}
async function purchaseAugmentations(ns, faction) {
    while (true) {
        const ownedAugmentations = ns.singularity.getOwnedAugmentations(true);
        const notOwnedAugmentations = await buildNotOwnedAugmentationsList(ns, faction, ownedAugmentations);
        if (notOwnedAugmentations.length == 0) {
            break;
        }
        const augmentationPriceList = notOwnedAugmentations.map((a) => {
            const price = ns.singularity.getAugmentationPrice(a);
            const augmentation = {
                name: a,
                price: price
            };
            ns.print(`Augmentation: ${a} has price of ${ns.format.number(price)}\$`);
            return augmentation;
        });
        const availableAugmentations = augmentationPriceList.filter((a) => {
            const preRequisites = ns.singularity.getAugmentationPrereq(a.name);
            const hasNoPrerequisites = preRequisites.length == 0;
            const allPrerequisitesAreOwned = preRequisites.every((b) => ownedAugmentations.some((c) => b == c));
            if (hasNoPrerequisites || allPrerequisitesAreOwned) {
                return true;
            }
            return false;
        });
        const sortedAugmentations = availableAugmentations.sort((a, b) => b.price - a.price);
        const mostExpensiveAugmentation = sortedAugmentations[0];
        ns.print(`Most expensive augmentation is ${mostExpensiveAugmentation.name} with a price of ${ns.format.number(mostExpensiveAugmentation.price)}\$`);
        await waitForReputation(ns, faction, mostExpensiveAugmentation.name);
        await waitForMoney(ns, mostExpensiveAugmentation.name);
        ns.singularity.purchaseAugmentation(faction, mostExpensiveAugmentation.name);
        await ns.sleep(1000);
    }
}
async function joinAndWorkForFaction(ns, faction) {
    ns.print(`Next faction: ${JSON.stringify(faction, null, 4)}`);
    ns.singularity.joinFaction(faction);
    if (['Sector-12', 'Slum Snakes'].includes(faction)) {
        ns.singularity.workForFaction(faction, 'field');
    }
    else {
        ns.singularity.workForFaction(faction, 'hacking');
    }
}
async function waitAndDestroyWorldDaemon(ns) {
    ns.print('No faction left');
    await ns.sleep(5000);
    ns.singularity.travelToCity('Sector-12');
    ns.singularity.universityCourse('Rothman University', 'Algorithms');
    const worldDaemon = 'w0r1d_d43m0n';
    ns.print(`Waiting for root access on ${worldDaemon}`);
    while (!ns.hasRootAccess(worldDaemon)) {
        await ns.sleep(5000);
    }
    ns.print(`${worldDaemon} is root accessible`);
    ns.tprint(`${worldDaemon} is root accessible`);
    ns.singularity.destroyW0r1dD43m0n(12, 'bootstrap.js');
}
export async function main(ns) {
    ns.disableLog('ALL');
    const nextFaction = await getNextFaction(ns);
    if (nextFaction === 'NO-FACTION-LEFT') {
        await waitAndDestroyWorldDaemon(ns);
    }
    await joinAndWorkForFaction(ns, nextFaction);
    await purchaseAugmentations(ns, nextFaction);
    ns.singularity.installAugmentations('bootstrap.js');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlLWZhY3Rpb25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc2NyaXB0cy9tYW5hZ2UtZmFjdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsS0FBSyxVQUFVLDhCQUE4QixDQUFDLEVBQU0sRUFBRSxPQUFlLEVBQUUsa0JBQTRCO0lBQ2pHLE1BQU0sYUFBYSxHQUFhLEVBQUUsQ0FBQyxXQUFXLENBQUMsMkJBQTJCLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEYsTUFBTSxxQkFBcUIsR0FBYSxFQUFFLENBQUM7SUFDM0MsS0FBSyxNQUFNLFlBQVksSUFBSSxhQUFhLEVBQUU7UUFDeEMsSUFBSSxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLEVBQUU7WUFDN0MsU0FBUztTQUNWO1FBRUQscUJBQXFCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0tBQzFDO0lBRUQsT0FBTyxxQkFBcUIsQ0FBQztBQUMvQixDQUFDO0FBRUQsS0FBSyxVQUFVLGNBQWMsQ0FBQyxFQUFNO0lBQ2xDLE1BQU0sa0JBQWtCLEdBQWE7UUFDbkMsWUFBWSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsWUFBWTtRQUNuRSxXQUFXLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxXQUFXO1FBQ25ELGNBQWMsRUFBRSxZQUFZLEVBQUUsVUFBVTtLQUFDLENBQUM7SUFDNUMsTUFBTSxrQkFBa0IsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBRXRFLEtBQUssTUFBTSxPQUFPLElBQUksa0JBQWtCLEVBQUU7UUFDeEMsRUFBRSxDQUFDLEtBQUssQ0FBQyxrQkFBa0IsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUN0QyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUU7WUFDcEIsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFB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QWdCLENBQUMsb0JBQW9CLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFFcEUsTUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDO0lBQ25DLEVBQUUsQ0FBQyxLQUFLLENBQUMsOEJBQThCLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDdEQsT0FBTyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLEVBQUU7UUFDckMsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0tBQ3RCO0lBRUQsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLFdBQVcscUJBQXFCLENBQUMsQ0FBQztJQUM5QyxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0lBQy9DLEVBQUUsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsRUFBRSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3hELENBQUM7QUFFRCxNQUFNLENBQUMsS0FBSyxVQUFVLElBQUksQ0FBQyxFQUFNO0lBQy9CLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFckIsTUFBTSxXQUFXLEdBQUcsTUFBTSxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7SUFFN0MsSUFBSSxXQUFXLEtBQUssaUJBQWlCLEVBQUU7UUFDckMsTUFBTSx5QkFBeUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNyQztJQUVELE1BQU0scUJBQXFCLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTdDLE1BQU0scUJBQXFCLENBQUMsRUFBRSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBRTdDLEVBQUUsQ0FBQyxXQUFXLENBQUMsb0JBQW9CLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDdEQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5TIH0gZnJvbSAnQG5zJztcblxuaW50ZXJmYWNlIGF1Z21lbnRhdGlvbiB7XG4gIG5hbWU6IHN0cmluZyxcbiAgcHJpY2U6IG51bWJlclxufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZE5vdE93bmVkQXVnbWVudGF0aW9uc0xpc3QobnM6IE5TLCBmYWN0aW9uOiBzdHJpbmcsIG93bmVkQXVnbWVudGF0aW9uczogc3RyaW5nW10pOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gIGNvbnN0IGF1Z21lbnRhdGlvbnM6IHN0cmluZ1tdID0gbnMuc2luZ3VsYXJpdHkuZ2V0QXVnbWVudGF0aW9uc0Zyb21GYWN0aW9uKGZhY3Rpb24pO1xuICBjb25zdCBub3RPd25lZEF1Z21lbnRhdGlvbnM6IHN0cmluZ1tdID0gW107XG4gIGZvciAoY29uc3QgYXVnbWVudGF0aW9uIG9mIGF1Z21lbnRhdGlvbnMpIHtcbiAgICBpZiAob3duZWRBdWdtZW50YXRpb25zLmluY2x1ZGVzKGF1Z21lbnRhdGlvbikpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIG5vdE93bmVkQXVnbWVudGF0aW9ucy5wdXNoKGF1Z21lbnRhdGlvbik7XG4gIH1cblxuICByZXR1cm4gbm90T3duZWRBdWdtZW50YXRpb25zO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXROZXh0RmFjdGlvbihuczogTlMpOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBmYWN0aW9uc09mSW50ZXJlc3Q6IHN0cmluZ1tdID0gW1xuICAgICdOZXRidXJuZXJzJywgJ0N5YmVyU2VjJywgJ05pdGVTZWMnLCAnVGhlIEJsYWNrIEhhbmQnLCAnQml0UnVubmVycycsXG4gICAgJ1NlY3Rvci0xMicsICdTbHVtIFNuYWtlcycsICdWb2xoYXZlbicsICdDaG9uZ3FpbmcnLFxuICAgICdUaGUgQ292ZW5hbnQnLCAnSWxsdW1pbmF0aScsICdEYWVkYWx1cyddO1xuICBjb25zdCBvd25lZEF1Z21lbnRhdGlvbnMgPSBucy5zaW5ndWxhcml0eS5nZXRPd25lZEF1Z21lbnRhdGlvbnModHJ1ZSk7XG5cbiAgZm9yIChjb25zdCBmYWN0aW9uIG9mIGZhY3Rpb25zT2ZJbnRlcmVzdCkge1xuICAgIG5zLnByaW50KGBUcnlpbmcgdG8gam9pbiAke2ZhY3Rpb259YCk7XG4gICAgaWYgKG5zLmdhbmcuaW5HYW5nKCkpIHtcbiAgICAgIGNvbnN0IGdhbmdJbmZvcm1hdGlvbiA9IG5zLmdhbmcuZ2V0R2FuZ0luZm9ybWF0aW9uKCk7XG4gICAgICBpZiAoZ2FuZ0luZm9ybWF0aW9uWydmYWN0aW9uJ10gPT0gZmFjdGlvbikge1xuICAgICAgICBucy5wcmludChgU2tpcHBpbmcgZ2FuZyBmYWN0aW9uOiAke2ZhY3Rpb259YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChmYWN0aW9uID09ICdWb2xoYXZlbicpIHsgIC8vIEZvciAnY29tYmF0IHJpYiBJSSdcbiAgICAgIHdoaWxlIChucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSgnaG9tZScpIDwgMjAwMDAwKSB7XG4gICAgICAgIG5zLnByaW50KCdXYWl0aW5nIGZvciBtb25leSBmb3IgVm9saGF2ZW4nKTtcbiAgICAgICAgYXdhaXQgbnMuc2xlZXAoNTAwKTtcbiAgICAgIH1cbiAgICAgIG5zLnNpbmd1bGFyaXR5LnRyYXZlbFRvQ2l0eSgnVm9saGF2ZW4nKTtcbiAgICB9IGVsc2UgaWYgKGZhY3Rpb24gPT0gJ0Nob25ncWluZycpIHsgLy8gRm9yICdOZXVyZWdlbiBHZW5lIE1vZGlmaWNhdGlvbidcbiAgICAgIHdoaWxlIChucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSgnaG9tZScpIDwgMjAwMDAwKSB7XG4gICAgICAgIG5zLnByaW50KCdXYWl0aW5nIGZvciBtb25leSBmb3IgQ2hvbmdxaW5nJyk7XG4gICAgICAgIGF3YWl0IG5zLnNsZWVwKDUwMCk7XG4gICAgICB9XG4gICAgICBucy5zaW5ndWxhcml0eS50cmF2ZWxUb0NpdHkoJ0Nob25ncWluZycpO1xuICAgIH1cblxuICAgIC8vIEZvciByZXF1aXJlZCBza2lsbHMgb3RoZXIgdGhhbiBoYWNraW5nXG4gICAgaWYgKFsnVGhlIENvdmVuYW50JywgJ0lsbHVtaW5hdGknLCAnRGFlZGFsdXMnXS5pbmNsdWRlcyhmYWN0aW9uKSkgeyAgLy8gVG8gaW5jcmVhc2UgY29tYmF0IHN0YXRcbiAgICAgIG5zLnNpbmd1bGFyaXR5LmpvaW5GYWN0aW9uKCdUaGUgQmxhY2sgSGFuZCcpO1xuICAgICAgbnMuc2luZ3VsYXJpdHkud29ya0ZvckZhY3Rpb24oJ1RoZSBCbGFjayBIYW5kJywgJ2ZpZWxkJyk7XG4gICAgfSBlbHNlIGlmIChbJ1NsdW0gU25ha2VzJ10uaW5jbHVkZXMoZmFjdGlvbikpIHsgIC8vIFRvIGxvd2VyIHBsYXllciBrYXJtYVxuICAgICAgbnMuc2luZ3VsYXJpdHkuY29tbWl0Q3JpbWUoXCJNdWdcIik7XG4gICAgfVxuXG4gICAgd2hpbGUgKCFucy5zaW5ndWxhcml0eS5jaGVja0ZhY3Rpb25JbnZpdGF0aW9ucygpLmluY2x1ZGVzKGZhY3Rpb24pICYmICFucy5nZXRQbGF5ZXIoKS5mYWN0aW9ucy5pbmNsdWRlcyhmYWN0aW9uKSkge1xuICAgICAgYXdhaXQgbnMuc2xlZXAoNTAwMCk7XG4gICAgfVxuXG4gICAgY29uc3Qgbm90T3duZWRBdWdtZW50YXRpb25zID0gYXdhaXQgYnVpbGROb3RPd25lZEF1Z21lbnRhdGlvbnNMaXN0KG5zLCBmYWN0aW9uLCBvd25lZEF1Z21lbnRhdGlvbnMpO1xuICAgIG5zLnByaW50KGBGYWN0aW9uOiAke2ZhY3Rpb259LCBudW0gb2Ygbm90IG93bmVkIGF1ZzogJHtub3RPd25lZEF1Z21lbnRhdGlvbnMubGVuZ3RofWApO1xuXG4gICAgaWYgKG5vdE93bmVkQXVnbWVudGF0aW9ucy5sZW5ndGggPT0gMCkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhY3Rpb247XG4gIH1cblxuICByZXR1cm4gJ05PLUZBQ1RJT04tTEVGVCc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JSZXB1dGF0aW9uKG5zOiBOUywgZmFjdGlvbjogc3RyaW5nLCBhdWdtZW50YXRpb246IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB3aGlsZSAobnMuc2luZ3VsYXJpdHkuZ2V0QXVnbWVudGF0aW9uUmVwUmVxKGF1Z21lbnRhdGlvbikgPiBucy5zaW5ndWxhcml0eS5nZXRGYWN0aW9uUmVwKGZhY3Rpb24pKSB7XG4gICAgbnMucHJpbnQoYEF1Z21lbnRhdGlvbiByZXB1dGF0aW9uOiAke25zLmZvcm1hdC5udW1iZXIobnMuc2luZ3VsYXJpdHkuZ2V0QXVnbWVudGF0aW9uUmVwUmVxKGF1Z21lbnRhdGlvbikpfSwgY3VycmVudCByZXB1dGF0aW9uOiAke25zLmZvcm1hdC5udW1iZXIobnMuc2luZ3VsYXJpdHkuZ2V0RmFjdGlvblJlcChmYWN0aW9uKSl9YCk7XG4gICAgYXdhaXQgbnMuc2xlZXAoNTAwMCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvck1vbmV5KG5zOiBOUywgYXVnbWVudGF0aW9uOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgd2hpbGUgKG5zLnNpbmd1bGFyaXR5LmdldEF1Z21lbnRhdGlvblByaWNlKGF1Z21lbnRhdGlvbikgPiBucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSgnaG9tZScpKSB7XG4gICAgbnMucHJpbnQoYEF1Z21lbnRhdGlvbiBwcmljZTogJHtucy5mb3JtYXQubnVtYmVyKG5zLnNpbmd1bGFyaXR5LmdldEF1Z21lbnRhdGlvblByaWNlKGF1Z21lbnRhdGlvbikpfVxcJCwgbW9uZXkgYXZhaWxhYmxlOiAke25zLmZvcm1hdC5udW1iZXIobnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUoJ2hvbWUnKSl9XFwkYCk7XG4gICAgYXdhaXQgbnMuc2xlZXAoNTAwMCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHVyY2hhc2VBdWdtZW50YXRpb25zKG5zOiBOUywgZmFjdGlvbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIHdoaWxlICh0cnVlKSB7XG4gICAgY29uc3Qgb3duZWRBdWdtZW50YXRpb25zID0gbnMuc2luZ3VsYXJpdHkuZ2V0T3duZWRBdWdtZW50YXRpb25zKHRydWUpO1xuICAgIGNvbnN0IG5vdE93bmVkQXVnbWVudGF0aW9ucyA9IGF3YWl0IGJ1aWxkTm90T3duZWRBdWdtZW50YXRpb25zTGlzdChucywgZmFjdGlvbiwgb3duZWRBdWdtZW50YXRpb25zKTtcbiAgICBpZiAobm90T3duZWRBdWdtZW50YXRpb25zLmxlbmd0aCA9PSAwKSB7XG4gICAgICBicmVhaztcbiAgICB9XG5cbiAgICBjb25zdCBhdWdtZW50YXRpb25QcmljZUxpc3QgPSBub3RPd25lZEF1Z21lbnRhdGlvbnMubWFwKChhOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IHByaWNlID0gbnMuc2luZ3VsYXJpdHkuZ2V0QXVnbWVudGF0aW9uUHJpY2UoYSk7XG4gICAgICBjb25zdCBhdWdtZW50YXRpb246IGF1Z21lbnRhdGlvbiA9IHtcbiAgICAgICAgbmFtZTogYSxcbiAgICAgICAgcHJpY2U6IHByaWNlXG4gICAgICB9O1xuXG4gICAgICBucy5wcmludChgQXVnbWVudGF0aW9uOiAke2F9IGhhcyBwcmljZSBvZiAke25zLmZvcm1hdC5udW1iZXIocHJpY2UpfVxcJGApO1xuXG4gICAgICByZXR1cm4gYXVnbWVudGF0aW9uO1xuICAgIH0pO1xuXG4gICAgY29uc3QgYXZhaWxhYmxlQXVnbWVudGF0aW9ucyA9IGF1Z21lbnRhdGlvblByaWNlTGlzdC5maWx0ZXIoKGE6IGF1Z21lbnRhdGlvbikgPT4ge1xuICAgICAgY29uc3QgcHJlUmVxdWlzaXRlcyA9IG5zLnNpbmd1bGFyaXR5LmdldEF1Z21lbnRhdGlvblByZXJlcShhLm5hbWUpO1xuICAgICAgY29uc3QgaGFzTm9QcmVyZXF1aXNpdGVzID0gcHJlUmVxdWlzaXRlcy5sZW5ndGggPT0gMDtcbiAgICAgIGNvbnN0IGFsbFByZXJlcXVpc2l0ZXNBcmVPd25lZCA9IHByZVJlcXVpc2l0ZXMuZXZlcnkoKGI6IHN0cmluZykgPT4gb3duZWRBdWdtZW50YXRpb25zLnNvbWUoKGM6IHN0cmluZykgPT4gYiA9PSBjKSk7XG5cbiAgICAgIGlmIChoYXNOb1ByZXJlcXVpc2l0ZXMgfHwgYWxsUHJlcmVxdWlzaXRlc0FyZU93bmVkKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBjb25zdCBzb3J0ZWRBdWdtZW50YXRpb25zID0gYXZhaWxhYmxlQXVnbWVudGF0aW9ucy5zb3J0KChhOiBhdWdtZW50YXRpb24sIGI6IGF1Z21lbnRhdGlvbikgPT4gYi5wcmljZSAtIGEucHJpY2UpO1xuICAgIGNvbnN0IG1vc3RFeHBlbnNpdmVBdWdtZW50YXRpb246IGF1Z21lbnRhdGlvbiA9IHNvcnRlZEF1Z21lbnRhdGlvbnNbMF07XG5cbiAgICBucy5wcmludChgTW9zdCBleHBlbnNpdmUgYXVnbWVudGF0aW9uIGlzICR7bW9zdEV4cGVuc2l2ZUF1Z21lbnRhdGlvbi5uYW1lfSB3aXRoIGEgcHJpY2Ugb2YgJHtucy5mb3JtYXQubnVtYmVyKG1vc3RFeHBlbnNpdmVBdWdtZW50YXRpb24ucHJpY2UpfVxcJGApO1xuICAgIGF3YWl0IHdhaXRGb3JSZXB1dGF0aW9uKG5zLCBmYWN0aW9uLCBtb3N0RXhwZW5zaXZlQXVnbWVudGF0aW9uLm5hbWUpO1xuICAgIGF3YWl0IHdhaXRGb3JNb25leShucywgbW9zdEV4cGVuc2l2ZUF1Z21lbnRhdGlvbi5uYW1lKTtcbiAgICBucy5zaW5ndWxhcml0eS5wdXJjaGFzZUF1Z21lbnRhdGlvbihmYWN0aW9uLCBtb3N0RXhwZW5zaXZlQXVnbWVudGF0aW9uLm5hbWUpO1xuXG4gICAgYXdhaXQgbnMuc2xlZXAoMTAwMCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gam9pbkFuZFdvcmtGb3JGYWN0aW9uKG5zOiBOUywgZmFjdGlvbjogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIG5zLnByaW50KGBOZXh0IGZhY3Rpb246ICR7SlNPTi5zdHJpbmdpZnkoZmFjdGlvbiwgbnVsbCwgNCl9YCk7XG4gIG5zLnNpbmd1bGFyaXR5LmpvaW5GYWN0aW9uKGZhY3Rpb24pO1xuXG4gIGlmIChbJ1NlY3Rvci0xMicsICdTbHVtIFNuYWtlcyddLmluY2x1ZGVzKGZhY3Rpb24pKSB7XG4gICAgbnMuc2luZ3VsYXJpdHkud29ya0ZvckZhY3Rpb24oZmFjdGlvbiwgJ2ZpZWxkJyk7XG4gIH0gZWxzZSB7XG4gICAgbnMuc2luZ3VsYXJpdHkud29ya0ZvckZhY3Rpb24oZmFjdGlvbiwgJ2hhY2tpbmcnKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0QW5kRGVzdHJveVdvcmxkRGFlbW9uKG5zOiBOUyk6IFByb21pc2U8dm9pZD4ge1xuICBucy5wcmludCgnTm8gZmFjdGlvbiBsZWZ0Jyk7XG5cbiAgYXdhaXQgbnMuc2xlZXAoNTAwMCk7XG4gIG5zLnNpbmd1bGFyaXR5LnRyYXZlbFRvQ2l0eSgnU2VjdG9yLTEyJyk7XG4gIG5zLnNpbmd1bGFyaXR5LnVuaXZlcnNpdHlDb3Vyc2UoJ1JvdGhtYW4gVW5pdmVyc2l0eScsICdBbGdvcml0aG1zJyk7XG5cbiAgY29uc3Qgd29ybGREYWVtb24gPSAndzByMWRfZDQzbTBuJztcbiAgbnMucHJpbnQoYFdhaXRpbmcgZm9yIHJvb3QgYWNjZXNzIG9uICR7d29ybGREYWVtb259YCk7XG4gIHdoaWxlICghbnMuaGFzUm9vdEFjY2Vzcyh3b3JsZERhZW1vbikpIHtcbiAgICBhd2FpdCBucy5zbGVlcCg1MDAwKTtcbiAgfVxuXG4gIG5zLnByaW50KGAke3dvcmxkRGFlbW9ufSBpcyByb290IGFjY2Vzc2libGVgKTtcbiAgbnMudHByaW50KGAke3dvcmxkRGFlbW9ufSBpcyByb290IGFjY2Vzc2libGVgKTtcbiAgbnMuc2luZ3VsYXJpdHkuZGVzdHJveVcwcjFkRDQzbTBuKDEyLCAnYm9vdHN0cmFwLmpzJyk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWluKG5zOiBOUyk6IFByb21pc2U8dm9pZD4ge1xuICBucy5kaXNhYmxlTG9nKCdBTEwnKTtcblxuICBjb25zdCBuZXh0RmFjdGlvbiA9IGF3YWl0IGdldE5leHRGYWN0aW9uKG5zKTtcblxuICBpZiAobmV4dEZhY3Rpb24gPT09ICdOTy1GQUNUSU9OLUxFRlQnKSB7XG4gICAgYXdhaXQgd2FpdEFuZERlc3Ryb3lXb3JsZERhZW1vbihucyk7XG4gIH1cblxuICBhd2FpdCBqb2luQW5kV29ya0ZvckZhY3Rpb24obnMsIG5leHRGYWN0aW9uKTtcblxuICBhd2FpdCBwdXJjaGFzZUF1Z21lbnRhdGlvbnMobnMsIG5leHRGYWN0aW9uKTtcblxuICBucy5zaW5ndWxhcml0eS5pbnN0YWxsQXVnbWVudGF0aW9ucygnYm9vdHN0cmFwLmpzJyk7XG59XG5cbiJdfQ==