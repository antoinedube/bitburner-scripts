const HISTORY_SIZE = 50;
const COMMISSION_FREE = 100000;
function fetchStocksWithDetails(ns) {
    const stocks = [];
    for (const symbol of ns.stock.getSymbols()) {
        const position = ns.stock.getPosition(symbol);
        const stock = {
            'symbol': symbol,
            'organization': ns.stock.getOrganization(symbol),
            'price': ns.stock.getPrice(symbol),
            'ask-price': ns.stock.getAskPrice(symbol),
            'bid-price': ns.stock.getBidPrice(symbol),
            'gain-unit-long': ns.stock.getSaleGain(symbol, 1, 'Long'),
            'gain-unit-short': ns.stock.getSaleGain(symbol, 1, 'Short'),
            'shares-owned-long': position[0],
            'average-price-long': position[1],
            'shares-owned-short': position[2],
            'average-price-short': position[3]
        };
        if (ns.stock.hasTIXApiAccess) {
            stock['forecast'] = ns.stock.getForecast(symbol);
            stock['volatilify'] = ns.tock.getVolatility(symbol);
        }
        stocks.push(stock);
    }
    return stocks;
}
function addToStocksWithHistories(ns, stocksWithHistories, stocks) {
    for (const stock of stocks) {
        const symbol = stock['symbol'];
        const price = stock['price'];
        if (!stocksWithHistories[symbol]) {
            stocksWithHistories[symbol] = [];
        }
        stocksWithHistories[symbol].push(price);
        if (stocksWithHistories[symbol].length > HISTORY_SIZE) {
            stocksWithHistories[symbol].shift();
        }
    }
}
function buildBuyList(ns, stocks, stocksWithHistories) {
    const buyList = [];
    for (const stock of stocks) {
        const currentPrice = stock['price'];
        const priceHistory = stocksWithHistories[stock['symbol']].slice(0, -1);
        const minPriceFromHistory = Math.min(...priceHistory);
        if (minPriceFromHistory < currentPrice) {
            continue;
        }
        const maxShares = ns.stock.getMaxShares(stock['symbol']);
        const numSharesWithAvailableMoney = Math.floor((ns.getServerMoneyAvailable('home') - COMMISSION_FREE) / stock['ask-price']);
        const numSharesToBuy = Math.min(10000, maxShares, numSharesWithAvailableMoney);
        const purchaseCost = ns.stock.getPurchaseCost(stock['symbol'], numSharesToBuy, 'long');
        buyList.push({
            'symbol': stock['symbol'],
            'num-shares': numSharesToBuy,
            'purchase-cost': purchaseCost,
            'position': 'long'
        });
    }
    buyList.sort((a, b) => b['purchase-cost'] - a['purchase-cost']);
    return buyList;
}
function buyShares(ns, buyList) {
    for (const stock of buyList) {
        if (stock['purchase-cost'] < ns.getServerMoneyAvailable('home')) {
            const pricePaidPerShare = ns.stock.buyStock(stock['symbol'], stock['num-shares']);
            ns.print(`${new Date()} --> Buying shares of ${stock['symbol']} --> Price paid: ${ns.formatNumber(stock['purchase-cost'])}\$ at ${ns.formatNumber(pricePaidPerShare)}\$ each`);
        }
    }
}
function buildSellList(ns, stocks) {
    const sellList = [];
    for (const stock of stocks) {
        const numSharesToSell = Math.floor(0.25 * stock['shares-owned-long']);
        const saleGain = ns.stock.getSaleGain(stock['symbol'], numSharesToSell, 'long');
        const stockValue = numSharesToSell * stock['average-price-long'];
        if (saleGain < 0.0 || saleGain <= stockValue) {
            continue;
        }
        sellList.push({
            'symbol': stock['symbol'],
            'num-shares': numSharesToSell,
            'sale-gain': saleGain,
            'position': 'long'
        });
    }
    return sellList;
}
function sellShares(ns, sellList) {
    for (const stock of sellList) {
        const moneyEarnedPerShare = ns.stock.sellStock(stock['symbol'], stock['num-shares']);
        ns.print(`${new Date()} --> Selling shares of ${stock['symbol']} --> Money earned: ${ns.formatNumber(stock['sale-gain'])}\$ at ${ns.formatNumber(moneyEarnedPerShare)}\$ each`);
    }
}
/** @param {NS} ns */
export async function main(ns) {
    ns.disableLog('ALL');
    const stocksWithHistories = {};
    for (let i = 0; i < HISTORY_SIZE; i++) {
        const stockList = fetchStocksWithDetails(ns);
        addToStocksWithHistories(ns, stocksWithHistories, stockList);
        await ns.stock.nextUpdate();
        ns.print(`[warm-up] TICK ${i + 1} of ${HISTORY_SIZE}`);
    }
    while (true) {
        const stocks = fetchStocksWithDetails(ns);
        addToStocksWithHistories(ns, stocksWithHistories, stocks);
        const buyList = buildBuyList(ns, stocks, stocksWithHistories);
        buyShares(ns, buyList);
        const sellList = buildSellList(ns, stocks);
        sellShares(ns, sellList);
        await ns.stock.nextUpdate();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuYWdlLXN0b2NrLW1hcmtldC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NjcmlwdHMvbWFuYWdlLXN0b2NrLW1hcmtldC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDeEIsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDO0FBRS9CLFNBQVMsc0JBQXNCLENBQUMsRUFBRTtJQUNqQyxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFFbEIsS0FBSyxNQUFNLE1BQU0sSUFBSSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxFQUFFO1FBQzNDLE1BQU0sUUFBUSxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLE1BQU0sS0FBSyxHQUFHO1lBQ2IsUUFBUSxFQUFFLE1BQU07WUFDaEIsY0FBYyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQztZQUNoRCxPQUFPLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ2xDLFdBQVcsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUM7WUFDekMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQztZQUN6QyxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLE1BQU0sQ0FBQztZQUN6RCxpQkFBaUIsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLE9BQU8sQ0FBQztZQUMzRCxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLG9CQUFvQixFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDakMsb0JBQW9CLEVBQUUsUUFBUSxD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O1FBQzVCLEVBQUUsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLE9BQU8sWUFBWSxFQUFFLENBQUMsQ0FBQztLQUN2RDtJQUVELE9BQU8sSUFBSSxFQUFFO1FBQ1osTUFBTSxNQUFNLEdBQUcsc0JBQXNCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUMsd0JBQXdCLENBQUMsRUFBRSxFQUFFLG1CQUFtQixFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBRTFELE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLG1CQUFtQixDQUFDLENBQUM7UUFDOUQsU0FBUyxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUV2QixNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzNDLFVBQVUsQ0FBQyxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFekIsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO0tBQzVCO0FBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEhJU1RPUllfU0laRSA9IDUwO1xuY29uc3QgQ09NTUlTU0lPTl9GUkVFID0gMTAwMDAwO1xuXG5mdW5jdGlvbiBmZXRjaFN0b2Nrc1dpdGhEZXRhaWxzKG5zKSB7XG5cdGNvbnN0IHN0b2NrcyA9IFtdO1xuXG5cdGZvciAoY29uc3Qgc3ltYm9sIG9mIG5zLnN0b2NrLmdldFN5bWJvbHMoKSkge1xuXHRcdGNvbnN0IHBvc2l0aW9uID0gbnMuc3RvY2suZ2V0UG9zaXRpb24oc3ltYm9sKTtcblx0XHRjb25zdCBzdG9jayA9IHtcblx0XHRcdCdzeW1ib2wnOiBzeW1ib2wsXG5cdFx0XHQnb3JnYW5pemF0aW9uJzogbnMuc3RvY2suZ2V0T3JnYW5pemF0aW9uKHN5bWJvbCksXG5cdFx0XHQncHJpY2UnOiBucy5zdG9jay5nZXRQcmljZShzeW1ib2wpLFxuXHRcdFx0J2Fzay1wcmljZSc6IG5zLnN0b2NrLmdldEFza1ByaWNlKHN5bWJvbCksXG5cdFx0XHQnYmlkLXByaWNlJzogbnMuc3RvY2suZ2V0QmlkUHJpY2Uoc3ltYm9sKSxcblx0XHRcdCdnYWluLXVuaXQtbG9uZyc6IG5zLnN0b2NrLmdldFNhbGVHYWluKHN5bWJvbCwgMSwgJ0xvbmcnKSxcblx0XHRcdCdnYWluLXVuaXQtc2hvcnQnOiBucy5zdG9jay5nZXRTYWxlR2FpbihzeW1ib2wsIDEsICdTaG9ydCcpLFxuXHRcdFx0J3NoYXJlcy1vd25lZC1sb25nJzogcG9zaXRpb25bMF0sXG5cdFx0XHQnYXZlcmFnZS1wcmljZS1sb25nJzogcG9zaXRpb25bMV0sXG5cdFx0XHQnc2hhcmVzLW93bmVkLXNob3J0JzogcG9zaXRpb25bMl0sXG5cdFx0XHQnYXZlcmFnZS1wcmljZS1zaG9ydCc6IHBvc2l0aW9uWzNdXG5cdFx0fVxuXG5cdFx0aWYgKG5zLnN0b2NrLmhhc1RJWEFwaUFjY2Vzcykge1xuXHRcdFx0c3RvY2tbJ2ZvcmVjYXN0J10gPSBucy5zdG9jay5nZXRGb3JlY2FzdChzeW1ib2wpO1xuXHRcdFx0c3RvY2tbJ3ZvbGF0aWxpZnknXSA9IG5zLnRvY2suZ2V0Vm9sYXRpbGl0eShzeW1ib2wpO1xuXHRcdH1cblxuXHRcdHN0b2Nrcy5wdXNoKHN0b2NrKTtcblx0fVxuXG5cdHJldHVybiBzdG9ja3M7XG59XG5cbmZ1bmN0aW9uIGFkZFRvU3RvY2tzV2l0aEhpc3Rvcmllcyhucywgc3RvY2tzV2l0aEhpc3Rvcmllcywgc3RvY2tzKSB7XG5cdGZvciAoY29uc3Qgc3RvY2sgb2Ygc3RvY2tzKSB7XG5cdFx0Y29uc3Qgc3ltYm9sID0gc3RvY2tbJ3N5bWJvbCddO1xuXHRcdGNvbnN0IHByaWNlID0gc3RvY2tbJ3ByaWNlJ107XG5cblx0XHRpZiAoIXN0b2Nrc1dpdGhIaXN0b3JpZXNbc3ltYm9sXSkge1xuXHRcdFx0c3RvY2tzV2l0aEhpc3Rvcmllc1tzeW1ib2xdID0gW107XG5cdFx0fVxuXG5cdFx0c3RvY2tzV2l0aEhpc3Rvcmllc1tzeW1ib2xdLnB1c2gocHJpY2UpO1xuXG5cdFx0aWYgKHN0b2Nrc1dpdGhIaXN0b3JpZXNbc3ltYm9sXS5sZW5ndGggPiBISVNUT1JZX1NJWkUpIHtcblx0XHRcdHN0b2Nrc1dpdGhIaXN0b3JpZXNbc3ltYm9sXS5zaGlmdCgpO1xuXHRcdH1cblx0fVxufVxuXG5mdW5jdGlvbiBidWlsZEJ1eUxpc3QobnMsIHN0b2Nrcywgc3RvY2tzV2l0aEhpc3Rvcmllcykge1xuXHRjb25zdCBidXlMaXN0ID0gW107XG5cdGZvciAoY29uc3Qgc3RvY2sgb2Ygc3RvY2tzKSB7XG5cdFx0Y29uc3QgY3VycmVudFByaWNlID0gc3RvY2tbJ3ByaWNlJ107XG5cdFx0Y29uc3QgcHJpY2VIaXN0b3J5ID0gc3RvY2tzV2l0aEhpc3Rvcmllc1tzdG9ja1snc3ltYm9sJ11dLnNsaWNlKDAsIC0xKTtcblx0XHRjb25zdCBtaW5QcmljZUZyb21IaXN0b3J5ID0gTWF0aC5taW4oLi4ucHJpY2VIaXN0b3J5KTtcblxuXHRcdGlmIChtaW5QcmljZUZyb21IaXN0b3J5IDwgY3VycmVudFByaWNlKSB7XG5cdFx0XHRjb250aW51ZTtcblx0XHR9XG5cblx0XHRjb25zdCBtYXhTaGFyZXMgPSBucy5zdG9jay5nZXRNYXhTaGFyZXMoc3RvY2tbJ3N5bWJvbCddKTtcblx0XHRjb25zdCBudW1TaGFyZXNXaXRoQXZhaWxhYmxlTW9uZXkgPSBNYXRoLmZsb29yKChucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZSgnaG9tZScpIC0gQ09NTUlTU0lPTl9GUkVFKSAvIHN0b2NrWydhc2stcHJpY2UnXSk7XG5cdFx0Y29uc3QgbnVtU2hhcmVzVG9CdXkgPSBNYXRoLm1pbigxMDAwMCwgbWF4U2hhcmVzLCBudW1TaGFyZXNXaXRoQXZhaWxhYmxlTW9uZXkpO1xuXHRcdGNvbnN0IHB1cmNoYXNlQ29zdCA9IG5zLnN0b2NrLmdldFB1cmNoYXNlQ29zdChzdG9ja1snc3ltYm9sJ10sIG51bVNoYXJlc1RvQnV5LCAnbG9uZycpO1xuXG5cdFx0YnV5TGlzdC5wdXNoKHtcblx0XHRcdCdzeW1ib2wnOiBzdG9ja1snc3ltYm9sJ10sXG5cdFx0XHQnbnVtLXNoYXJlcyc6IG51bVNoYXJlc1RvQnV5LFxuXHRcdFx0J3B1cmNoYXNlLWNvc3QnOiBwdXJjaGFzZUNvc3QsXG5cdFx0XHQncG9zaXRpb24nOiAnbG9uZydcblx0XHR9KTtcblx0fVxuXG5cdGJ1eUxpc3Quc29ydCgoYSwgYikgPT4gYlsncHVyY2hhc2UtY29zdCddIC0gYVsncHVyY2hhc2UtY29zdCddKTtcblxuXHRyZXR1cm4gYnV5TGlzdDtcbn1cblxuZnVuY3Rpb24gYnV5U2hhcmVzKG5zLCBidXlMaXN0KSB7XG5cdGZvciAoY29uc3Qgc3RvY2sgb2YgYnV5TGlzdCkge1xuXHRcdGlmIChzdG9ja1sncHVyY2hhc2UtY29zdCddIDwgbnMuZ2V0U2VydmVyTW9uZXlBdmFpbGFibGUoJ2hvbWUnKSkge1xuXHRcdFx0Y29uc3QgcHJpY2VQYWlkUGVyU2hhcmUgPSBucy5zdG9jay5idXlTdG9jayhzdG9ja1snc3ltYm9sJ10sIHN0b2NrWydudW0tc2hhcmVzJ10pO1xuXHRcdFx0bnMucHJpbnQoYCR7bmV3IERhdGUoKX0gLS0+IEJ1eWluZyBzaGFyZXMgb2YgJHtzdG9ja1snc3ltYm9sJ119IC0tPiBQcmljZSBwYWlkOiAke25zLmZvcm1hdE51bWJlcihzdG9ja1sncHVyY2hhc2UtY29zdCddKX1cXCQgYXQgJHtucy5mb3JtYXROdW1iZXIocHJpY2VQYWlkUGVyU2hhcmUpfVxcJCBlYWNoYCk7XG5cdFx0fVxuXHR9XG59XG5cbmZ1bmN0aW9uIGJ1aWxkU2VsbExpc3QobnMsIHN0b2Nrcykge1xuXHRjb25zdCBzZWxsTGlzdCA9IFtdO1xuXHRmb3IgKGNvbnN0IHN0b2NrIG9mIHN0b2Nrcykge1xuXHRcdGNvbnN0IG51bVNoYXJlc1RvU2VsbCA9IE1hdGguZmxvb3IoMC4yNSAqIHN0b2NrWydzaGFyZXMtb3duZWQtbG9uZyddKTtcblx0XHRjb25zdCBzYWxlR2FpbiA9IG5zLnN0b2NrLmdldFNhbGVHYWluKHN0b2NrWydzeW1ib2wnXSwgbnVtU2hhcmVzVG9TZWxsLCAnbG9uZycpO1xuXHRcdGNvbnN0IHN0b2NrVmFsdWUgPSBudW1TaGFyZXNUb1NlbGwgKiBzdG9ja1snYXZlcmFnZS1wcmljZS1sb25nJ107XG5cblx0XHRpZiAoc2FsZUdhaW4gPCAwLjAgfHwgc2FsZUdhaW4gPD0gc3RvY2tWYWx1ZSkge1xuXHRcdFx0Y29udGludWU7XG5cdFx0fVxuXG5cdFx0c2VsbExpc3QucHVzaCh7XG5cdFx0XHQnc3ltYm9sJzogc3RvY2tbJ3N5bWJvbCddLFxuXHRcdFx0J251bS1zaGFyZXMnOiBudW1TaGFyZXNUb1NlbGwsXG5cdFx0XHQnc2FsZS1nYWluJzogc2FsZUdhaW4sXG5cdFx0XHQncG9zaXRpb24nOiAnbG9uZydcblx0XHR9KTtcblx0fVxuXG5cdHJldHVybiBzZWxsTGlzdDtcbn1cblxuZnVuY3Rpb24gc2VsbFNoYXJlcyhucywgc2VsbExpc3QpIHtcblx0Zm9yIChjb25zdCBzdG9jayBvZiBzZWxsTGlzdCkge1xuXHRcdGNvbnN0IG1vbmV5RWFybmVkUGVyU2hhcmUgPSBucy5zdG9jay5zZWxsU3RvY2soc3RvY2tbJ3N5bWJvbCddLCBzdG9ja1snbnVtLXNoYXJlcyddKTtcblx0XHRucy5wcmludChgJHtuZXcgRGF0ZSgpfSAtLT4gU2VsbGluZyBzaGFyZXMgb2YgJHtzdG9ja1snc3ltYm9sJ119IC0tPiBNb25leSBlYXJuZWQ6ICR7bnMuZm9ybWF0TnVtYmVyKHN0b2NrWydzYWxlLWdhaW4nXSl9XFwkIGF0ICR7bnMuZm9ybWF0TnVtYmVyKG1vbmV5RWFybmVkUGVyU2hhcmUpfVxcJCBlYWNoYCk7XG5cdH1cbn1cblxuLyoqIEBwYXJhbSB7TlN9IG5zICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbWFpbihucykge1xuXHRucy5kaXNhYmxlTG9nKCdBTEwnKTtcblx0Y29uc3Qgc3RvY2tzV2l0aEhpc3RvcmllcyA9IHt9O1xuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgSElTVE9SWV9TSVpFOyBpKyspIHtcblx0XHRjb25zdCBzdG9ja0xpc3QgPSBmZXRjaFN0b2Nrc1dpdGhEZXRhaWxzKG5zKTtcblx0XHRhZGRUb1N0b2Nrc1dpdGhIaXN0b3JpZXMobnMsIHN0b2Nrc1dpdGhIaXN0b3JpZXMsIHN0b2NrTGlzdCk7XG5cblx0XHRhd2FpdCBucy5zdG9jay5uZXh0VXBkYXRlKCk7XG5cdFx0bnMucHJpbnQoYFt3YXJtLXVwXSBUSUNLICR7aSArIDF9IG9mICR7SElTVE9SWV9TSVpFfWApO1xuXHR9XG5cblx0d2hpbGUgKHRydWUpIHtcblx0XHRjb25zdCBzdG9ja3MgPSBmZXRjaFN0b2Nrc1dpdGhEZXRhaWxzKG5zKTtcblx0XHRhZGRUb1N0b2Nrc1dpdGhIaXN0b3JpZXMobnMsIHN0b2Nrc1dpdGhIaXN0b3JpZXMsIHN0b2Nrcyk7XG5cblx0XHRjb25zdCBidXlMaXN0ID0gYnVpbGRCdXlMaXN0KG5zLCBzdG9ja3MsIHN0b2Nrc1dpdGhIaXN0b3JpZXMpO1xuXHRcdGJ1eVNoYXJlcyhucywgYnV5TGlzdCk7XG5cblx0XHRjb25zdCBzZWxsTGlzdCA9IGJ1aWxkU2VsbExpc3QobnMsIHN0b2Nrcyk7XG5cdFx0c2VsbFNoYXJlcyhucywgc2VsbExpc3QpO1xuXG5cdFx0YXdhaXQgbnMuc3RvY2submV4dFVwZGF0ZSgpO1xuXHR9XG59Il19