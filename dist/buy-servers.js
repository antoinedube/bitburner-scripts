import { scanAllNetwork } from "./scan";
function generateUUID() {
    // https://stackoverflow.com/questions/105034/how-do-i-create-a-guid-uuid
    // crypto.randomUUID();
    // crypto.getRandomValues();
}
/** @param {NS} ns */
function launchScript(ns, scriptName, server) {
    const scpStatus = ns.scp(scriptName, server, 'home');
    if (!scpStatus) {
        ns.print('Failed to copy ' + scriptName + ' on ' + server);
    }
    ns.killall(server);
    const maxRam = ns.getServerMaxRam(server);
    const usedRam = ns.getServerUsedRam(server);
    const availableRam = maxRam - usedRam;
    const scriptRam = ns.getScriptRam(scriptName, server);
    const numThreads = Math.floor(availableRam / scriptRam);
    if (numThreads > 0) {
        if (ns.exec(scriptName, server, numThreads) == 0) {
            ns.print('Error launching script');
        }
    }
}
/** @param {NS} ns */
export async function main(ns) {
    ns.disableLog('ALL');
    const BUYING_DELAY = 250;
    const UPGRADING_DELAY = 5 * 1000;
    const FOLLOWING_BATCH_DELAY = 1000 * 30;
    const HOME_SERVER = 'home';
    let targetRam = 4;
    while (targetRam <= ns.getPurchasedServerMaxRam()) {
        const maxNumberOfServers = ns.getPurchasedServerLimit();
        const availableMoney = ns.getServerMoneyAvailable('home');
        const serverCost = ns.getPurchasedServerCost(targetRam);
        if (availableMoney < maxNumberOfServers * serverCost) {
            targetRam /= 2;
            break;
        }
        targetRam *= 2;
    }
    if (targetRam < 8) {
        targetRam = 8;
    }
    if (targetRam > ns.getPurchasedServerMaxRam()) {
        targetRam = 0.5 * ns.getPurchasedServerMaxRam();
    }
    ns.print(`Starting target ram: ${targetRam}`);
    // Purchase missing servers
    while (true) {
        // List current servers
        const serverList = scanAllNetwork(ns);
        let purchasedServers = serverList.filter(name => name.startsWith('neighbor-'));
        // Stopping criteria
        if (purchasedServers.length == ns.getPurchasedServerLimit()) {
            break;
        }
        // If limit is not reached, buy server at current targetRam
        if (ns.getPurchasedServerCost(targetRam) < ns.getServerMoneyAvailable(HOME_SERVER)) {
            const name = `neighbor-${purchasedServers.length}`;
            ns.print(`Purchasing server ${name}`);
            ns.purchaseServer(name, targetRam);
            launchScript(ns, 'hack-remote.js', name);
            purchasedServers.push(name);
        }
        await ns.sleep(BUYING_DELAY);
    }
    const purchasedServers = scanAllNetwork(ns).filter(name => name.startsWith('neighbor-'));
    targetRam *= 2;
    while (true) {
        // Stopping criteria
        let countServerWithTargetRam = 0;
        for (const purchasedServer of purchasedServers) {
            const purchasedServerRam = ns.getServer(purchasedServer).maxRam;
            if (purchasedServerRam >= targetRam) {
                countServerWithTargetRam++;
            }
        }
        if (countServerWithTargetRam == ns.getPurchasedServerLimit()) {
            if (targetRam >= ns.getPurchasedServerMaxRam()) {
                break;
            }
            targetRam *= 2;
            ns.print(`New RAM target: ${targetRam}`);
            await ns.sleep(FOLLOWING_BATCH_DELAY);
        }
        for (const purchasedServer of purchasedServers) {
            const purchasedServerRam = ns.getServer(purchasedServer).maxRam;
            if (purchasedServerRam < targetRam) {
                const moneyAvailable = ns.getServerMoneyAvailable('home');
                const upgradeCost = ns.getPurchasedServerUpgradeCost(purchasedServer, targetRam);
                if (upgradeCost < moneyAvailable) {
                    if (ns.upgradePurchasedServer(purchasedServer, targetRam)) {
                        ns.print(`Upgraded ${purchasedServer} to ${ns.formatRam(targetRam)} with cost of ${ns.formatNumber(upgradeCost)}\$`);
                        launchScript(ns, 'hack-remote.js', purchasedServer);
                    }
                    else {
                        ns.print(`Error while upgrading purchased server ${purchasedServer} to ${ns.formatRam(targetRam)}`);
                    }
                }
            }
        }
        await ns.sleep(UPGRADING_DELAY);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnV5LXNlcnZlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zY3JpcHRzL2J1eS1zZXJ2ZXJzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFeEMsU0FBUyxZQUFZO0lBQ3BCLHlFQUF5RTtJQUN6RSx1QkFBdUI7SUFDdkIsNEJBQTRCO0FBQzdCLENBQUM7QUFFRCxxQkFBcUI7QUFDckIsU0FBUyxZQUFZLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNO0lBQzNDLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNyRCxJQUFJLENBQUMsU0FBUyxFQUFFO1FBQ2YsRUFBRSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLEdBQUcsTUFBTSxHQUFHLE1BQU0sQ0FBQyxDQUFDO0tBQzNEO0lBRUQsRUFBRSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUVuQixNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzFDLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QyxNQUFNLFlBQVksR0FBRyxNQUFNLEdBQUcsT0FBTyxDQUFDO0lBQ3RDLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3RELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxDQUFDO0lBQ3hELElBQUksVUFBVSxHQUFHLENBQUMsRUFBRTtRQUNuQixJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDakQsRUFBRSxDQUFDLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1NBQ25DO0tBQ0Q7QUFDRixDQUFDO0FBRUQscUJBQXFCO0FBQ3JCLE1BQU0sQ0FBQyxLQUFLLFVBQVUsSUFBSSxDQUFDLEVBQUU7SUFDNUIsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyQixNQUFNLFlBQVksR0FBRyxHQUFHLENBQUM7SUFDekIsTUFBTSxlQUFlLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztJQUNqQyxNQUFNLHFCQUFxQixHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFDeEMsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDO0lBRTNCLElBQUksU0FBUyxHQUFHLENBQUMsQ0FBQztJQUNsQixPQUFPLFNBQVMsSUFBSSxFQUFFLENBQUMsd0JBQXdCLEVBQUUsRUFBRTtRQUNsRCxNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxDQUFDO1FBQ3hELE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRCxNQUFNLFVBQVUsR0FBRyxFQUFFLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEQsSUFBSSxjQUFjLEdBQUcsa0JBQWtCLEdBQUcsVUFBVSxFQUFFO1lBQ3JELFNBQVMsSUFBSSxDQUFDLENBQUM7WUFDZixNQUFNO1NBQ047UUFFRCxTQUFTLElBQUksQ0FBQyxDQUFDO0tBQ2Y7SUFFRCxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUU7UUFDbEIsU0FBUyxHQUFHLENBQUMsQ0FBQztLQUNkO0lBRUQsSUFBSSxTQUFTLEdBQUMsRUFBRSxDQUFDLHdCQUF3QixFQUFFLEVBQUU7UUFDNUMsU0FBUyxHQUFHLEdBQUcsR0FBQyxFQUFFLENBQUMsd0JBQXdCLEVBQUUsQ0FBQztLQUM5QztJQUVELEVBQUUsQ0FBQyxLQUFLLENBQUMsd0JBQXdCLFNBQVMsRUFBRSxDQUFDLENBQUM7SUFFOUMsMkJBQTJCO0lBQzNCLE9BQU8sSUFBSSxFQUFFO1FBQ1osdUJBQXVCO1FBQ3ZCLE1BQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN0QyxJQUFJLGdCQUFnQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7UUFFL0Usb0JBQW9CO1FBQ3BCLElBQUksZ0JBQWdCLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyx1QkFBdUIsRUFBRSxFQUFFO1lBQzVELE1BQU07U0FDTjtRQUVELDJEQUEyRDtRQUMzRCxJQUFJLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDbkYsTUFBTSxJQUFJLEdBQUcsWUFBWSxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNuRCxFQUFFLENBQUMsS0FBSyxDQUFDLHFCQUFxQixJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3RDLEVBQUUsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ25DLFlBQVksQ0FBQyxFQUFFLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFekMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQzVCO1FBRUQsTUFBTSxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO0tBQzdCO0lBRUQsTUFBTSxnQkFBZ0IsR0FBRyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0lBRXpGLFNBQVMsSUFBSSxDQUFDLENBQUM7SUFDZixPQUFPLElBQUksRUFBRTtRQUNaLG9CQUFvQjtRQUNwQixJQUFJLHdCQUF3QixHQUFHLENBQUMsQ0FBQztRQUNqQyxLQUFLLE1BQU0sZUFBZSxJQUFJLGdCQUFnQixFQUFFO1lBQy9DLE1BQU0sa0JBQWtCLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDaEUsSUFBSSxrQkFBa0IsSUFBSSxTQUFTLEVBQUU7Z0JBQ3BDLHdCQUF3QixFQUFFLENBQUM7YUFDM0I7U0FDRDtRQUVELElBQUksd0JBQXdCLElBQUksRUFBRSxDQUFDLHVCQUF1QixFQUFFLEVBQUU7WUFDN0QsSUFBSSxTQUFTLElBQUksRUFBRSxDQUFDLHdCQUF3QixFQUFFLEVBQUU7Z0JBQy9DLE1BQU07YUFDTjtZQUVELFNBQVMsSUFBSSxDQUFDLENBQUM7WUFDZixFQUFFLENBQUMsS0FBSyxDQUFDLG1CQUFtQixTQUFTLEVBQUUsQ0FBQyxDQUFDO1lBQ3pDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsS0FBSyxNQUFNLGVBQWUsSUFBSSxnQkFBZ0IsRUFBRTtZQUMvQyxNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsTUFBTSxDQUFDO1lBQ2hFLElBQUksa0JBQWtCLEdBQUcsU0FBUyxFQUFFO2dCQUNuQyxNQUFNLGNBQWMsR0FBRyxFQUFFLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQzFELE1BQU0sV0FBVyxHQUFHLEVBQUUsQ0FBQyw2QkFBNkIsQ0FBQyxlQUFlLEVBQUUsU0FBUyxDQUFDLENBQUM7Z0JBQ2pGLElBQUksV0FBVyxHQUFHLGNBQWMsRUFBRTtvQkFDakMsSUFBSSxFQUFFLENBQUMsc0JBQXNCLENBQUMsZUFBZSxFQUFFLFNBQVMsQ0FBQyxFQUFFO3dCQUMxRCxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksZUFBZSxPQUFPLEVBQUUsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLGlCQUFpQixFQUFFLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDckgsWUFBWSxDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsQ0FBQztxQkFDcEQ7eUJBQU07d0JBQ04sRUFBRSxDQUFDLEtBQUssQ0FBQywwQ0FBMEMsZUFBZSxPQUFPLEVBQUUsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUNwRztpQkFDRDthQUNEO1NBQ0Q7UUFFRCxNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7S0FDaEM7QUFDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc2NhbkFsbE5ldHdvcmsgfSBmcm9tIFwiLi9zY2FuXCI7XG5cbmZ1bmN0aW9uIGdlbmVyYXRlVVVJRCgpIHtcblx0Ly8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMTA1MDM0L2hvdy1kby1pLWNyZWF0ZS1hLWd1aWQtdXVpZFxuXHQvLyBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuXHQvLyBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKCk7XG59XG5cbi8qKiBAcGFyYW0ge05TfSBucyAqL1xuZnVuY3Rpb24gbGF1bmNoU2NyaXB0KG5zLCBzY3JpcHROYW1lLCBzZXJ2ZXIpIHtcblx0Y29uc3Qgc2NwU3RhdHVzID0gbnMuc2NwKHNjcmlwdE5hbWUsIHNlcnZlciwgJ2hvbWUnKTtcblx0aWYgKCFzY3BTdGF0dXMpIHtcblx0XHRucy5wcmludCgnRmFpbGVkIHRvIGNvcHkgJyArIHNjcmlwdE5hbWUgKyAnIG9uICcgKyBzZXJ2ZXIpO1xuXHR9XG5cblx0bnMua2lsbGFsbChzZXJ2ZXIpO1xuXG5cdGNvbnN0IG1heFJhbSA9IG5zLmdldFNlcnZlck1heFJhbShzZXJ2ZXIpO1xuXHRjb25zdCB1c2VkUmFtID0gbnMuZ2V0U2VydmVyVXNlZFJhbShzZXJ2ZXIpO1xuXHRjb25zdCBhdmFpbGFibGVSYW0gPSBtYXhSYW0gLSB1c2VkUmFtO1xuXHRjb25zdCBzY3JpcHRSYW0gPSBucy5nZXRTY3JpcHRSYW0oc2NyaXB0TmFtZSwgc2VydmVyKTtcblx0Y29uc3QgbnVtVGhyZWFkcyA9IE1hdGguZmxvb3IoYXZhaWxhYmxlUmFtIC8gc2NyaXB0UmFtKTtcblx0aWYgKG51bVRocmVhZHMgPiAwKSB7XG5cdFx0aWYgKG5zLmV4ZWMoc2NyaXB0TmFtZSwgc2VydmVyLCBudW1UaHJlYWRzKSA9PSAwKSB7XG5cdFx0XHRucy5wcmludCgnRXJyb3IgbGF1bmNoaW5nIHNjcmlwdCcpO1xuXHRcdH1cblx0fVxufVxuXG4vKiogQHBhcmFtIHtOU30gbnMgKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBtYWluKG5zKSB7XG5cdG5zLmRpc2FibGVMb2coJ0FMTCcpO1xuXHRjb25zdCBCVVlJTkdfREVMQVkgPSAyNTA7XG5cdGNvbnN0IFVQR1JBRElOR19ERUxBWSA9IDUgKiAxMDAwO1xuXHRjb25zdCBGT0xMT1dJTkdfQkFUQ0hfREVMQVkgPSAxMDAwICogMzA7XG5cdGNvbnN0IEhPTUVfU0VSVkVSID0gJ2hvbWUnO1xuXG5cdGxldCB0YXJnZXRSYW0gPSA0O1xuXHR3aGlsZSAodGFyZ2V0UmFtIDw9IG5zLmdldFB1cmNoYXNlZFNlcnZlck1heFJhbSgpKSB7XG5cdFx0Y29uc3QgbWF4TnVtYmVyT2ZTZXJ2ZXJzID0gbnMuZ2V0UHVyY2hhc2VkU2VydmVyTGltaXQoKTtcblx0XHRjb25zdCBhdmFpbGFibGVNb25leSA9IG5zLmdldFNlcnZlck1vbmV5QXZhaWxhYmxlKCdob21lJyk7XG5cdFx0Y29uc3Qgc2VydmVyQ29zdCA9IG5zLmdldFB1cmNoYXNlZFNlcnZlckNvc3QodGFyZ2V0UmFtKTtcblxuXHRcdGlmIChhdmFpbGFibGVNb25leSA8IG1heE51bWJlck9mU2VydmVycyAqIHNlcnZlckNvc3QpIHtcblx0XHRcdHRhcmdldFJhbSAvPSAyO1xuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0dGFyZ2V0UmFtICo9IDI7XG5cdH1cblxuXHRpZiAodGFyZ2V0UmFtIDwgOCkge1xuXHRcdHRhcmdldFJhbSA9IDg7XG5cdH1cblxuXHRpZiAodGFyZ2V0UmFtPm5zLmdldFB1cmNoYXNlZFNlcnZlck1heFJhbSgpKSB7XG5cdFx0dGFyZ2V0UmFtID0gMC41Km5zLmdldFB1cmNoYXNlZFNlcnZlck1heFJhbSgpO1xuXHR9XG5cblx0bnMucHJpbnQoYFN0YXJ0aW5nIHRhcmdldCByYW06ICR7dGFyZ2V0UmFtfWApO1xuXG5cdC8vIFB1cmNoYXNlIG1pc3Npbmcgc2VydmVyc1xuXHR3aGlsZSAodHJ1ZSkge1xuXHRcdC8vIExpc3QgY3VycmVudCBzZXJ2ZXJzXG5cdFx0Y29uc3Qgc2VydmVyTGlzdCA9IHNjYW5BbGxOZXR3b3JrKG5zKTtcblx0XHRsZXQgcHVyY2hhc2VkU2VydmVycyA9IHNlcnZlckxpc3QuZmlsdGVyKG5hbWUgPT4gbmFtZS5zdGFydHNXaXRoKCduZWlnaGJvci0nKSk7XG5cblx0XHQvLyBTdG9wcGluZyBjcml0ZXJpYVxuXHRcdGlmIChwdXJjaGFzZWRTZXJ2ZXJzLmxlbmd0aCA9PSBucy5nZXRQdXJjaGFzZWRTZXJ2ZXJMaW1pdCgpKSB7XG5cdFx0XHRicmVhaztcblx0XHR9XG5cblx0XHQvLyBJZiBsaW1pdCBpcyBub3QgcmVhY2hlZCwgYnV5IHNlcnZlciBhdCBjdXJyZW50IHRhcmdldFJhbVxuXHRcdGlmIChucy5nZXRQdXJjaGFzZWRTZXJ2ZXJDb3N0KHRhcmdldFJhbSkgPCBucy5nZXRTZXJ2ZXJNb25leUF2YWlsYWJsZShIT01FX1NFUlZFUikpIHtcblx0XHRcdGNvbnN0IG5hbWUgPSBgbmVpZ2hib3ItJHtwdXJjaGFzZWRTZXJ2ZXJzLmxlbmd0aH1gO1xuXHRcdFx0bnMucHJpbnQoYFB1cmNoYXNpbmcgc2VydmVyICR7bmFtZX1gKTtcblx0XHRcdG5zLnB1cmNoYXNlU2VydmVyKG5hbWUsIHRhcmdldFJhbSk7XG5cdFx0XHRsYXVuY2hTY3JpcHQobnMsICdoYWNrLXJlbW90ZS5qcycsIG5hbWUpO1xuXG5cdFx0XHRwdXJjaGFzZWRTZXJ2ZXJzLnB1c2gobmFtZSk7XG5cdFx0fVxuXG5cdFx0YXdhaXQgbnMuc2xlZXAoQlVZSU5HX0RFTEFZKTtcblx0fVxuXG5cdGNvbnN0IHB1cmNoYXNlZFNlcnZlcnMgPSBzY2FuQWxsTmV0d29yayhucykuZmlsdGVyKG5hbWUgPT4gbmFtZS5zdGFydHNXaXRoKCduZWlnaGJvci0nKSk7XG5cblx0dGFyZ2V0UmFtICo9IDI7XG5cdHdoaWxlICh0cnVlKSB7XG5cdFx0Ly8gU3RvcHBpbmcgY3JpdGVyaWFcblx0XHRsZXQgY291bnRTZXJ2ZXJXaXRoVGFyZ2V0UmFtID0gMDtcblx0XHRmb3IgKGNvbnN0IHB1cmNoYXNlZFNlcnZlciBvZiBwdXJjaGFzZWRTZXJ2ZXJzKSB7XG5cdFx0XHRjb25zdCBwdXJjaGFzZWRTZXJ2ZXJSYW0gPSBucy5nZXRTZXJ2ZXIocHVyY2hhc2VkU2VydmVyKS5tYXhSYW07XG5cdFx0XHRpZiAocHVyY2hhc2VkU2VydmVyUmFtID49IHRhcmdldFJhbSkge1xuXHRcdFx0XHRjb3VudFNlcnZlcldpdGhUYXJnZXRSYW0rKztcblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoY291bnRTZXJ2ZXJXaXRoVGFyZ2V0UmFtID09IG5zLmdldFB1cmNoYXNlZFNlcnZlckxpbWl0KCkpIHtcblx0XHRcdGlmICh0YXJnZXRSYW0gPj0gbnMuZ2V0UHVyY2hhc2VkU2VydmVyTWF4UmFtKCkpIHtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHR9XG5cblx0XHRcdHRhcmdldFJhbSAqPSAyO1xuXHRcdFx0bnMucHJpbnQoYE5ldyBSQU0gdGFyZ2V0OiAke3RhcmdldFJhbX1gKTtcblx0XHRcdGF3YWl0IG5zLnNsZWVwKEZPTExPV0lOR19CQVRDSF9ERUxBWSk7XG5cdFx0fVxuXG5cdFx0Zm9yIChjb25zdCBwdXJjaGFzZWRTZXJ2ZXIgb2YgcHVyY2hhc2VkU2VydmVycykge1xuXHRcdFx0Y29uc3QgcHVyY2hhc2VkU2VydmVyUmFtID0gbnMuZ2V0U2VydmVyKHB1cmNoYXNlZFNlcnZlcikubWF4UmFtO1xuXHRcdFx0aWYgKHB1cmNoYXNlZFNlcnZlclJhbSA8IHRhcmdldFJhbSkge1xuXHRcdFx0XHRjb25zdCBtb25leUF2YWlsYWJsZSA9IG5zLmdldFNlcnZlck1vbmV5QXZhaWxhYmxlKCdob21lJyk7XG5cdFx0XHRcdGNvbnN0IHVwZ3JhZGVDb3N0ID0gbnMuZ2V0UHVyY2hhc2VkU2VydmVyVXBncmFkZUNvc3QocHVyY2hhc2VkU2VydmVyLCB0YXJnZXRSYW0pO1xuXHRcdFx0XHRpZiAodXBncmFkZUNvc3QgPCBtb25leUF2YWlsYWJsZSkge1xuXHRcdFx0XHRcdGlmIChucy51cGdyYWRlUHVyY2hhc2VkU2VydmVyKHB1cmNoYXNlZFNlcnZlciwgdGFyZ2V0UmFtKSkge1xuXHRcdFx0XHRcdFx0bnMucHJpbnQoYFVwZ3JhZGVkICR7cHVyY2hhc2VkU2VydmVyfSB0byAke25zLmZvcm1hdFJhbSh0YXJnZXRSYW0pfSB3aXRoIGNvc3Qgb2YgJHtucy5mb3JtYXROdW1iZXIodXBncmFkZUNvc3QpfVxcJGApO1xuXHRcdFx0XHRcdFx0bGF1bmNoU2NyaXB0KG5zLCAnaGFjay1yZW1vdGUuanMnLCBwdXJjaGFzZWRTZXJ2ZXIpO1xuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRucy5wcmludChgRXJyb3Igd2hpbGUgdXBncmFkaW5nIHB1cmNoYXNlZCBzZXJ2ZXIgJHtwdXJjaGFzZWRTZXJ2ZXJ9IHRvICR7bnMuZm9ybWF0UmFtKHRhcmdldFJhbSl9YCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0YXdhaXQgbnMuc2xlZXAoVVBHUkFESU5HX0RFTEFZKTtcblx0fVxufVxuIl19